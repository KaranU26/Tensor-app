// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  username     String?  @unique
  passwordHash String   @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  onboarding         UserOnboarding?
  notificationPrefs  NotificationPreference?
  subscription       Subscription?
  stretchingRoutines StretchingRoutine[]
  stretchingSessions StretchingSession[]
  flexibilityGoals   FlexibilityGoal[]
  bodyMetrics        BodyMetric[]
  strengthWorkouts   StrengthWorkout[]
  personalRecords    PersonalRecord[]
  notifications      Notification[]
  consents           UserConsent[]
  following          UserFollow[]            @relation("Following")
  followers          UserFollow[]            @relation("Followers")
  progressVideos     ProgressVideo[]
  dataExportRequests DataExportRequest[]
  deletionRequests   DeletionRequest[]

  @@map("users")
}

model UserOnboarding {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  completedAt DateTime? @map("completed_at")
  skipped     Boolean   @default(false)

  primaryGoal     String? @map("primary_goal")
  experienceLevel String? @map("experience_level")

  // Flexibility assessment
  toeTouchScore           Int?    @map("toe_touch_score")
  shoulderReachScore      Int?    @map("shoulder_reach_score")
  hipFlexibilityScore     Int?    @map("hip_flexibility_score")
  overallFlexibilityScore Int?    @map("overall_flexibility_score")
  flexibilityLevel        String? @map("flexibility_level")

  // Schedule preferences
  workoutDays          String? @map("workout_days") // JSON array as string
  preferredWorkoutTime String? @map("preferred_workout_time")
  stretchingPreference String? @map("stretching_preference")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user_onboarding")
}

model UserFollow {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  followingUserId String   @map("following_user_id")
  createdAt       DateTime @default(now()) @map("created_at")

  user      User @relation("Following", fields: [userId], references: [id], onDelete: Cascade)
  following User @relation("Followers", fields: [followingUserId], references: [id], onDelete: Cascade)

  @@unique([userId, followingUserId])
  @@map("user_follows")
}

// ============================================
// STRETCHING
// ============================================

model Stretch {
  id               String   @id @default(uuid())
  name             String
  description      String?
  durationSeconds  Int      @map("duration_seconds")
  videoUrl         String?  @map("video_url")
  thumbnailUrl     String?  @map("thumbnail_url")
  animationUrl     String?  @map("animation_url")
  difficulty       String   @default("beginner")
  primaryMuscles   String   @map("primary_muscles") // JSON array
  secondaryMuscles String?  @map("secondary_muscles") // JSON array
  instructions     String?
  tips             String? // JSON array
  commonMistakes   String?  @map("common_mistakes") // JSON array
  equipment        String? // JSON array
  tags             String? // JSON array
  createdAt        DateTime @default(now()) @map("created_at")

  routineStretches RoutineStretch[]
  sessionStretches SessionStretch[]

  @@map("stretches")
}

model StretchingRoutine {
  id     String  @id @default(uuid())
  userId String? @map("user_id")
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name            String
  description     String?
  difficulty      String  @default("beginner")
  durationSeconds Int     @map("duration_seconds")
  targetAreas     String? @map("target_areas") // JSON array
  tags            String? // JSON array
  isPublic        Boolean @default(false) @map("is_public")
  isSystem        Boolean @default(false) @map("is_system")
  usesCount       Int     @default(0) @map("uses_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  stretches RoutineStretch[]
  sessions  StretchingSession[]

  @@map("stretching_routines")
}

model RoutineStretch {
  id                    String @id @default(uuid())
  routineId             String @map("routine_id")
  stretchId             String @map("stretch_id")
  positionOrder         Int    @map("position_order")
  customDurationSeconds Int?   @map("custom_duration_seconds")

  routine StretchingRoutine @relation(fields: [routineId], references: [id], onDelete: Cascade)
  stretch Stretch           @relation(fields: [stretchId], references: [id], onDelete: Cascade)

  @@map("routine_stretches")
}

model StretchingSession {
  id          String  @id @default(uuid())
  userId      String  @map("user_id")
  routineId   String? @map("routine_id")
  routineName String? @map("routine_name")

  startedAt       DateTime  @map("started_at")
  completedAt     DateTime? @map("completed_at")
  durationSeconds Int?      @map("duration_seconds")
  completed       Boolean   @default(false)
  linkedWorkoutId String?   @map("linked_workout_id")
  notes           String?

  createdAt DateTime @default(now()) @map("created_at")

  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  routine   StretchingRoutine? @relation(fields: [routineId], references: [id])
  stretches SessionStretch[]

  @@map("stretching_sessions")
}

model SessionStretch {
  id                  String   @id @default(uuid())
  sessionId           String   @map("session_id")
  stretchId           String   @map("stretch_id")
  heldDurationSeconds Int      @map("held_duration_seconds")
  feltTight           Boolean  @default(false) @map("felt_tight")
  positionInRoutine   Int      @map("position_in_routine")
  completedAt         DateTime @default(now()) @map("completed_at")

  session StretchingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  stretch Stretch           @relation(fields: [stretchId], references: [id])

  @@map("session_stretches")
}

// ============================================
// FLEXIBILITY GOALS
// ============================================

model FlexibilityGoal {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  goalType    String    @map("goal_type")
  description String?
  targetArea  String    @map("target_area")
  baselineRom Float?    @map("baseline_rom")
  targetRom   Float?    @map("target_rom")
  targetDate  DateTime? @map("target_date")
  status      String    @default("active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  measurements   RomMeasurement[]
  progressVideos ProgressVideo[]

  @@map("flexibility_goals")
}

model RomMeasurement {
  id     String          @id @default(uuid())
  goalId String          @map("goal_id")
  goal   FlexibilityGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  romDegrees        Float    @map("rom_degrees")
  measurementDate   DateTime @default(now()) @map("measurement_date")
  measurementMethod String?  @map("measurement_method")
  notes             String?

  createdAt DateTime @default(now()) @map("created_at")

  @@map("rom_measurements")
}

model ProgressVideo {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  goalId     String?  @map("goal_id")
  videoUrl   String   @map("video_url")
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  user User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  goal FlexibilityGoal? @relation(fields: [goalId], references: [id])

  @@map("progress_videos")
}

// ============================================
// STRENGTH TRAINING
// ============================================

model Exercise {
  id               String  @id @default(uuid())
  name             String
  description      String?
  category         String // barbell, dumbbell, machine, bodyweight, cable, kettlebell
  equipmentNeeded  String? @map("equipment_needed") // JSON array
  videoUrl         String? @map("video_url")
  thumbnailUrl     String? @map("thumbnail_url")
  primaryMuscles   String  @map("primary_muscles") // JSON array
  secondaryMuscles String? @map("secondary_muscles") // JSON array
  difficulty       String  @default("beginner")
  instructions     String?
  tips             String? // JSON array
  commonMistakes   String? @map("common_mistakes") // JSON array
  isCompound       Boolean @default(false) @map("is_compound")
  isUnilateral     Boolean @default(false) @map("is_unilateral")

  // Research-backed biomechanical fields
  forceType     String? @map("force_type") // push, pull, static
  mechanic      String? // compound, isolation (redundant with isCompound but explicit)
  metValue      Float?  @map("met_value") // Metabolic Equivalent for calorie calculation
  is1RMEligible Boolean @default(true) @map("is_1rm_eligible") // Can calculate 1RM?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  workoutExercises WorkoutExercise[]
  personalRecords  PersonalRecord[]

  @@map("exercises")
}

model StrengthWorkout {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name                String?
  startedAt           DateTime  @map("started_at")
  completedAt         DateTime? @map("completed_at")
  durationSeconds     Int?      @map("duration_seconds")
  sessionIntensityRpe Int?      @map("session_intensity_rpe")
  notes               String?
  totalVolume         Float?    @map("total_volume")

  createdAt DateTime @default(now()) @map("created_at")

  exercises WorkoutExercise[]

  @@map("strength_workouts")
}

model WorkoutExercise {
  id            String  @id @default(uuid())
  workoutId     String  @map("workout_id")
  exerciseId    String  @map("exercise_id")
  positionOrder Int     @map("position_order")
  notes         String?

  createdAt DateTime @default(now()) @map("created_at")

  workout  StrengthWorkout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  exercise Exercise        @relation(fields: [exerciseId], references: [id])
  sets     WorkoutSet[]

  @@map("workout_exercises")
}

model WorkoutSet {
  id                String @id @default(uuid())
  workoutExerciseId String @map("workout_exercise_id")
  setNumber         Int    @map("set_number")

  reps            Int?
  weight          Float?
  weightUnit      String  @default("lbs") @map("weight_unit")
  setType         String  @default("normal") @map("set_type")
  rpe             Int?
  isPr            Boolean @default(false) @map("is_pr")
  completed       Boolean @default(true)
  restSeconds     Int?    @map("rest_seconds")
  durationSeconds Int?    @map("duration_seconds")
  distanceMeters  Float?  @map("distance_meters")

  createdAt DateTime @default(now()) @map("created_at")

  workoutExercise WorkoutExercise @relation(fields: [workoutExerciseId], references: [id], onDelete: Cascade)

  @@map("workout_sets")
}

model PersonalRecord {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  exerciseId String   @map("exercise_id")
  recordType String   @map("record_type") // 1rm, 3rm, 5rm, max_reps, max_weight
  value      Float
  weightUnit String   @default("lbs") @map("weight_unit")
  achievedAt DateTime @default(now()) @map("achieved_at")
  workoutId  String?  @map("workout_id")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id])

  @@unique([userId, exerciseId, recordType])
  @@map("personal_records")
}

// ============================================
// BODY METRICS
// ============================================

model BodyMetric {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  weight            Float?
  weightUnit        String   @default("lbs") @map("weight_unit")
  bodyFatPercentage Float?   @map("body_fat_percentage")
  chest             Float?
  waist             Float?
  hips              Float?
  arms              Float?
  thighs            Float?
  measurementUnit   String   @default("inches") @map("measurement_unit")
  measurementDate   DateTime @default(now()) @map("measurement_date")
  notes             String?

  createdAt DateTime @default(now()) @map("created_at")

  @@map("body_metrics")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  notificationType String    @map("notification_type")
  title            String
  body             String?
  actionType       String?   @map("action_type")
  actionData       String?   @map("action_data") // JSON
  sentAt           DateTime? @map("sent_at")
  readAt           DateTime? @map("read_at")
  clickedAt        DateTime? @map("clicked_at")
  deliveryStatus   String    @default("pending") @map("delivery_status")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("notifications")
}

model NotificationPreference {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  notificationsEnabled Boolean @default(true) @map("notifications_enabled")
  stretchReminders     Boolean @default(true) @map("stretch_reminders")
  workoutReminders     Boolean @default(true) @map("workout_reminders")
  streakNotifications  Boolean @default(true) @map("streak_notifications")
  goalNotifications    Boolean @default(true) @map("goal_notifications")
  socialNotifications  Boolean @default(true) @map("social_notifications")
  recoverySuggestions  Boolean @default(true) @map("recovery_suggestions")
  inactivityNudges     Boolean @default(false) @map("inactivity_nudges")

  quietHoursEnabled Boolean @default(true) @map("quiet_hours_enabled")
  quietHoursStart   String  @default("22:00") @map("quiet_hours_start")
  quietHoursEnd     String  @default("08:00") @map("quiet_hours_end")

  maxDailyNotifications Int    @default(5) @map("max_daily_notifications")
  stretchReminderTime   String @default("18:30") @map("stretch_reminder_time")
  workoutReminderTime   String @default("17:00") @map("workout_reminder_time")
  reminderDays          String @default("[\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\"]") @map("reminder_days")

  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("notification_preferences")
}

// ============================================
// SUBSCRIPTIONS
// ============================================

model Subscription {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  planType  String @default("free") @map("plan_type")
  status    String @default("active")
  pricePaid Float? @map("price_paid")
  currency  String @default("USD")

  startedAt   DateTime  @default(now()) @map("started_at")
  expiresAt   DateTime? @map("expires_at")
  cancelledAt DateTime? @map("cancelled_at")

  provider               String?
  providerSubscriptionId String? @map("provider_subscription_id")
  providerCustomerId     String? @map("provider_customer_id")

  trialStartedAt DateTime? @map("trial_started_at")
  trialEndsAt    DateTime? @map("trial_ends_at")
  isTrial        Boolean   @default(false) @map("is_trial")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("subscriptions")
}

// ============================================
// GDPR COMPLIANCE
// ============================================

model UserConsent {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  consentType String    @map("consent_type")
  version     String
  consented   Boolean
  consentedAt DateTime? @map("consented_at")
  withdrawnAt DateTime? @map("withdrawn_at")
  ipAddress   String?   @map("ip_address")
  userAgent   String?   @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("user_consents")
}

model DataExportRequest {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  status        String    @default("pending")
  requestedAt   DateTime  @default(now()) @map("requested_at")
  completedAt   DateTime? @map("completed_at")
  expiresAt     DateTime? @map("expires_at")
  downloadUrl   String?   @map("download_url")
  fileSizeBytes Int?      @map("file_size_bytes")

  @@map("data_export_requests")
}

model DeletionRequest {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  status            String    @default("pending")
  reason            String?
  requestedAt       DateTime  @default(now()) @map("requested_at")
  gracePeriodEndsAt DateTime? @map("grace_period_ends_at")
  completedAt       DateTime? @map("completed_at")
  cancelledAt       DateTime? @map("cancelled_at")

  @@map("deletion_requests")
}
